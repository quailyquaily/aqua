# Aqua CLI 友好化与 Relay 接入建议（2026-02-22）

## 目标

在不破坏现有命令习惯的前提下，降低 CLI 使用门槛，并为后续 `aqua-relay`（内网中继）接入预留清晰路径。

核心目标：

- 新手默认可用：尽量不要求理解 multiaddr 细节。
- 老用户不受影响：已有命令和参数尽量保持兼容。
- 网络自动选择：优先直连，失败后自动走 relay。

## 当前使用体验问题

1. `--address` 心智负担较高  
对 `hello/ping/capabilities/push` 来说，用户常常不知道何时必须手动传地址。

2. `card export` 地址决策复杂  
`--address` 与 `--listen` 混用、可拨号地址筛选、交互选择，对自动化脚本不够友好。

3. `push` 的会话参数认知成本偏高  
对话类 topic 需要 UUIDv7 `session_id`，虽然可自动生成，但用户不一定知道可以省略参数。

4. 错误提示可操作性不足  
很多错误缺少“下一步怎么做”的直接指引。

## 接入 Relay 前可独立落地的优化点

以下项不依赖 `aqua-relay`，可先做并立即提升易用性：

1. 主流程文档改写为“默认不传 `--address`”  
推荐路径统一成：`init -> contacts import -> hello/ping/push`，把显式地址标注为高级选项。

2. `push` 省略 `--session-id` 时自动生成 UUIDv7  
对话类 topic 不再要求手工构造会话 ID，同时保留显式指定能力。

3. `push` 入参统一为 `--message`  
去掉 `--text`，减少术语歧义（这是一次破坏性参数调整）。

4. 常见错误补“下一步命令”  
示例：缺会话 ID、无可拨号地址、联系人的地址与 peer_id 不匹配时，直接给可执行修复命令。

5. `contacts` 输出更可读  
`contacts list/show` 增加简短字段解释或更清晰的列名，降低新手理解成本。

6. `card export` 的非交互体验增强  
在非 TTY 场景下给出更明确的参数建议（例如提示补充 `--address`），减少 CI/脚本误用。

## 建议的 CLI 形态（接入 aqua-relay 后）

### 1) 主流程命令保持不变（兼容优先）

以下命令保留原形态，继续支持只传 `<peer_id>`：

```bash
aqua hello <peer_id>
aqua ping <peer_id>
aqua capabilities <peer_id>
aqua push <peer_id> --topic chat.message --message "hello"
```

地址来源策略保持为：

- 若传了 `--address`，优先用显式地址。
- 若没传 `--address`，使用 contact card 内地址。
- 拨号时默认 `direct -> relay` 顺序尝试（自动兜底）。

### 2) 在 `serve` 增加 relay 相关参数（节点侧能力）

建议新增：

- `--relay <multiaddr>`（可重复）：配置一个或多个 relay 节点。
- `--relay-mode auto|off|required`（默认 `auto`）：
  - `auto`：可直连则直连，必要时走 relay。
  - `off`：禁用 relay，仅直连。
  - `required`：仅走 relay（用于受限网络调试或强制策略）。

示例：

```bash
aqua serve \
  --listen /ip4/0.0.0.0/tcp/6371 \
  --relay /dns4/relay.example.com/tcp/6371/p2p/12D3K... \
  --relay-mode auto
```

### 3) 在 `card export` 增加“地址发布策略”

建议新增：

- `--advertise direct|relay|both|auto`（默认 `auto`）。

建议语义：

- `direct`：只发布直连地址。
- `relay`：只发布 relay 地址。
- `both`：同时发布 direct + relay 地址。
- `auto`：按本机网络和配置自动选择，倾向 `both`。

示例：

```bash
aqua card export --advertise both --out ./my.card.json
```

这样可减少用户手填多条 `--address` 的频次。

### 4) 提升 `push` 的默认可用性

建议新增/调整：

- 省略 `--session-id` 时自动生成 UUIDv7（保留显式传入）。
- `push` 统一使用 `--message`，不再保留 `--text`。
- 对话 topic 缺少 session 时，报错直接给出可复制命令示例。

示例：

```bash
aqua push <peer_id> --topic dm.reply.v1 --message "follow up"
```

### 5) 错误提示统一增强（“报错 + 下一步”）

建议将常见错误统一为“原因 + 可执行建议”：

- 无可拨号地址：
  - 原因：contact 中缺少可用地址。
  - 建议：`aqua contacts show <peer_id>` / 重新 `contacts import` / 配置 relay。
- session 不合法：
  - 原因：topic 需要 UUIDv7 session。
  - 建议：不传 `--session-id` 让系统自动生成，或显式提供合法 UUIDv7。

## 推荐用户路径（接入 relay 后）

### 常规用户（推荐）

```bash
aqua init
aqua serve --relay <relay_addr>
aqua contacts import ./peer.card.json
aqua hello <peer_id>
aqua push <peer_id> --topic chat.message --message "hello"
```

用户无需理解 relay 细节，仅在 `serve` 或配置文件中设置一次。

### 高级用户（显式控制）

```bash
aqua hello <peer_id> --address <direct_addr>
aqua hello <peer_id> --address <relay_addr_with_p2p_circuit>
```

仍保留当前可控能力，不阻断专家场景。

## 兼容性与发布策略

1. 优先保持命令形态稳定；必要时允许小范围破坏性参数调整（例如 `--text` -> `--message`）。  
2. 文档中将“推荐路径”切换为无 `--address` 主流程。  
3. 对旧参数逐步弱化：先标注“高级/可选”，后续再评估是否弃用。  
4. 每次行为变化配套 `--help` 示例和错误示例，降低迁移成本。  

## 分阶段落地建议

### Phase 1（低风险，优先）

- 文档改造：Quick Start 改为默认自动拨号路径。
- `push` 省略 `--session-id` 自动生成 UUIDv7，并补充友好报错。
- `push` 参数从 `--text` 切换为 `--message`，并更新错误提示与示例。

### Phase 2（relay 接入期）

- `serve` 增加 `--relay` / `--relay-mode`。
- `card export` 增加 `--advertise`。
- `contacts show` 输出中标注地址类型（direct/relay）。

### Phase 3（稳定期）

- 增加 `aqua doctor`（可选）：诊断地址、relay、连通性和配置冲突。
- 增加 `aqua connect <peer_id>`（可选）：统一前置连通性检查入口。
