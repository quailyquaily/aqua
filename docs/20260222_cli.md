# Aqua CLI Usability and Relay Integration Suggestions (2026-02-22)

## Goal

Lower the CLI learning curve without breaking existing command habits, while leaving a clear path for upcoming `aqua-relay` (intranet relay) support.

Core goals:

- Usable by default for newcomers: avoid requiring multiaddr expertise.
- No disruption for existing users: keep current commands and flags as compatible as possible.
- Automatic network path selection: prefer direct, then fall back to relay.

## Current Usability Issues

1. `--address` has high cognitive load  
For `hello/ping/capabilities/push`, users often do not know when manual address input is required.

2. `card export` address selection is complex  
Mixing `--address` and `--listen`, dialability filtering, and interactive selection is not automation-friendly.

3. `push` session parameters are hard to reason about  
Dialogue topics require UUIDv7 `session_id`. It can be auto-generated, but users may not realize the parameter can be omitted.

4. Error messages are not action-oriented enough  
Many errors do not provide a clear "what to do next" command.

## Improvements That Can Land Before Relay

The following items do not depend on `aqua-relay` and can improve usability immediately:

1. Rewrite primary docs to default to "no `--address`"  
Recommended flow: `init -> contacts import -> hello/ping/push`, with explicit addresses treated as advanced usage.

2. Auto-generate UUIDv7 when `push` omits `--session-id`  
Dialogue topics no longer require manual session creation while preserving explicit override.

3. Unify push input as `--message`  
Drop `--text` to reduce term ambiguity (intentional breaking change).

4. Add "next command" guidance to common errors  
Examples: missing session ID, no dialable address, contact address/peer mismatch.

5. Make `contacts` output easier to read  
Improve `contacts list/show` with clearer columns or field hints.

6. Improve non-interactive `card export` behavior  
In non-TTY contexts, provide explicit parameter guidance (for example: suggest `--address`) to reduce CI/script misuse.

## Suggested CLI Shape (After `aqua-relay` Support)

### 1) Keep the main command shape stable (compatibility first)

Keep these commands in the same form, still requiring only `<peer_id>`:

```bash
aqua hello <peer_id>
aqua ping <peer_id>
aqua capabilities <peer_id>
aqua push <peer_id> --topic chat.message --message "hello"
```

Address source policy:

- If `--address` is provided, explicit addresses take precedence.
- If `--address` is omitted, use addresses from the contact card.
- Dial order defaults to `direct -> relay` with automatic fallback.

### 2) Add relay options to `serve` (node-side capability)

Suggested additions:

- `--relay <multiaddr>` (repeatable): configure one or more relay nodes.
- `--relay-mode auto|off|required` (default `auto`):
  - `auto`: use direct when possible, relay when needed.
  - `off`: disable relay, direct only.
  - `required`: relay only (for constrained-network debugging or strict policy).

Example:

```bash
aqua serve \
  --listen /ip4/0.0.0.0/tcp/6371 \
  --relay /dns4/relay.example.com/tcp/6371/p2p/12D3K... \
  --relay-mode auto
```

### 3) Add "address publishing strategy" to `card export`

Suggested addition:

- `--advertise direct|relay|both|auto` (default `auto`).

Suggested semantics:

- `direct`: publish direct addresses only.
- `relay`: publish relay addresses only.
- `both`: publish direct and relay addresses.
- `auto`: choose automatically based on host/network config, typically preferring `both`.

Example:

```bash
aqua card export --advertise both --out ./my.card.json
```

This reduces the need to manually type many `--address` entries.

### 4) Improve default usability of `push`

Suggested adjustments:

- Auto-generate UUIDv7 when `--session-id` is omitted (while still allowing explicit input).
- Standardize on `--message`; do not keep `--text`.
- When dialogue topics are missing session context, return copy-paste-friendly fix examples.

Example:

```bash
aqua push <peer_id> --topic dm.reply.v1 --message "follow up"
```

### 5) Standardize error output as "reason + next step"

For common failures, include direct recovery steps:

- No dialable address:
  - Reason: no usable addresses in contact data.
  - Suggestion: `aqua contacts show <peer_id>` / re-run `contacts import` / configure relay.
- Invalid session:
  - Reason: topic requires UUIDv7 session.
  - Suggestion: omit `--session-id` for auto-generation, or provide a valid UUIDv7.

## Recommended User Flow (After Relay Integration)

### Standard users (recommended)

```bash
aqua init
aqua serve --relay <relay_addr>
aqua contacts import ./peer.card.json
aqua hello <peer_id>
aqua push <peer_id> --topic chat.message --message "hello"
```

Users do not need relay internals; they configure it once in `serve` or config.

### Advanced users (explicit control)

```bash
aqua hello <peer_id> --address <direct_addr>
aqua hello <peer_id> --address <relay_addr_with_p2p_circuit>
```

This preserves expert control without blocking advanced workflows.

## Compatibility and Release Strategy

1. Keep command shapes stable whenever possible; allow scoped breaking changes only when necessary (for example: `--text` -> `--message`).  
2. Make "no `--address` by default" the documented primary path.  
3. Gradually downgrade old parameters: first mark as advanced/optional, then evaluate deprecation.  
4. Pair each behavior change with `--help` examples and failure examples to reduce migration cost.  

## Phased Rollout Proposal

### Phase 1 (low risk, high priority)

- Rewrite docs to favor automatic dial paths.
- Auto-generate UUIDv7 when `push` omits `--session-id`, with clearer errors.
- Move from `--text` to `--message`, and update examples and errors.

### Phase 2 (relay integration phase)

- Add `--relay` / `--relay-mode` to `serve`.
- Add `--advertise` to `card export`.
- Label address types (direct/relay) in `contacts show`.

### Phase 3 (stabilization phase)

- Add `aqua doctor` (optional): diagnose addresses, relay, connectivity, and config conflicts.
- Add `aqua connect <peer_id>` (optional): unified preflight connectivity check entrypoint.
