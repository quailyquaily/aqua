# 2026-02-22 Refactor Plan: Reduce Over-Design in Aqua

## Objective
Simplify Aqua's implementation to the minimum required for secure, reliable Aqua operation:
- trustworthy identity and peer verification
- stable hello + RPC connectivity
- durable inbox/outbox persistence
- clear, maintainable CLI behavior

This plan targets implementation complexity, not just documentation wording.

## First-Principles Boundaries
Keep:
- cryptographic identity/card validation
- peer-ID/public-key consistency checks
- request/payload size limits
- contact trust-state gating

Reduce or remove:
- transport-layer coupling to application envelope shape
- persistence/features with low current runtime value
- unused abstractions and test-only frameworks in production code paths
- high-complexity auto-behavior in CLI that hides operator intent

## In Scope
- `aqua/node.go`
- `aqua/rpc.go`
- `aqua/types.go`
- `aqua/store.go`
- `aqua/file_store.go`
- `cmd/aqua/main.go`
- `internal/fsstore/index.go` (and related tests)
- related tests in `aqua/*_test.go` and `internal/fsstore/*_test.go`

## Out of Scope
- protocol version bump
- network transport changes (libp2p stack)
- cryptographic algorithm changes

## Workstream A: Decouple Transport From App Envelope
Problem:
`agent.data.push` previously enforced a JSON envelope in core transport handling.

Status:
- Implemented: payload is now opaque at transport level, and CLI `push` sends message bytes directly (no extra JSON envelope).

Changes:
- Make payload opaque at Aqua transport level.
- Move `session_id` and `reply_to` to first-class RPC params (not parsed from payload JSON).
- Keep topic-level rule: dialogue topics require `session_id` (UUIDv7).
- Use `--message` as CLI payload input, treated as user payload construction only.

Primary files:
- `aqua/types.go`
- `aqua/rpc.go`
- `aqua/node.go`
- `cmd/aqua/main.go`

Compatibility:
- No backward compatibility for legacy payload-envelope parsing.
- This is a deliberate breaking change; all clients must send `session_id` / `reply_to` via RPC params.

Done when:
- `extractAndValidateSessionForTopic` payload-envelope dependency is removed.
- Push path works with arbitrary `application/json` payload (or non-JSON when enabled).

## Workstream B: Remove Protocol-History Persistence
Problem:
Protocol history persistence and downgrade warning logic add storage and interface complexity while only protocol v1 exists.

Changes:
- Remove `GetProtocolHistory` / `PutProtocolHistory` from `Store`.
- Remove protocol-history file handling in file store.
- Keep in-memory negotiated session cache only.

Primary files:
- `aqua/store.go`
- `aqua/node.go`
- `aqua/file_store.go`
- `aqua/types.go`

Compatibility:
- No backward compatibility requirement for protocol-history behavior.
- Existing `protocol_history.json` is treated as ignored legacy data.

Done when:
- No runtime code references protocol-history read/write paths.

## Workstream C: Narrow Strict JSON Usage
Problem:
Global strict JSON profile validation introduces high parsing complexity in runtime RPC paths.

Changes:
- Replace strict parser use in RPC request/response and data-push payload handling with standard decode + explicit field validation.
- Keep strict/canonical handling where it directly supports signed contact-card integrity.
- Remove `jsonprofile.go` only if fully unused after migration.

Primary files:
- `aqua/rpc.go`
- `aqua/node.go`
- `aqua/contact_card.go`
- `aqua/jsonprofile.go` (possibly deleted)

Compatibility:
- No backward compatibility requirement for strict JSON profile behavior in runtime RPC/push paths.
- Client-visible validation errors may change shape; protocol symbols remain stable.

Done when:
- Strict parser is limited to security-critical card/signature paths or removed with equivalent guarantees.

## Workstream D: Simplify CLI Address Resolution
Problem:
Card export address handling must stay user-friendly while reducing unnecessary branching complexity.

Changes:
- Keep user-friendly auto-discovery when `--address` is not provided.
- Keep deterministic address derivation from `--listen` plus local interface expansion for unspecified IPs.
- Keep loopback addresses available as selectable options (useful for local testing).
- Keep interactive terminal prompt when multiple dialable addresses are found.
- Keep current non-interactive behavior: require explicit `--address` when multiple options exist.
- Keep `--address` as explicit override when operators want strict control.
- If no dialable addresses exist, return a clear actionable error with invalid-address reasons.

Primary files:
- `cmd/aqua/main.go`

Done when:
- Card export remains easy for users who do not know how to compose addresses manually.
- Loopback endpoints remain available for testing scenarios.
- Multi-address export still requires explicit user choice (or explicit `--address`).
- Address resolution code is shorter and deterministic for identical inputs.

## Workstream E: Remove Dead/Speculative Abstractions
Problem:
Some abstractions are not used by runtime paths.

Changes:
- Remove `SessionScopeByTopic` if no production caller.
- Remove `internal/fsstore/index.go` if only test-referenced.
- Delete/update tests tied only to removed abstractions.

Primary files:
- `aqua/topic.go`
- `internal/fsstore/index.go`
- related tests

Done when:
- No production package contains abstractions without runtime call sites.

## Implementation Order (PR Sequence)
1. PR-1: Workstream A (transport/app decoupling) + compatibility tests.
2. PR-2: Workstream B (protocol-history removal) + store contract cleanup.
3. PR-3: Workstream C (strict JSON narrowing) + parser behavior tests.
4. PR-4: Workstream D (CLI address simplification) + CLI help/docs updates.
5. PR-5: Workstream E (dead code removal) + test suite cleanup.
6. PR-6: Final pass: naming cleanup, docs sync, regression checklist.

## Test Strategy
Run on every PR:
- `go test ./...`
- `go test -race ./...`

Add/adjust targeted tests:
- data push with arbitrary payload and explicit `session_id`
- dialogue-topic validation failure without `session_id`
- store behavior after protocol-history removal
- CLI behavior for multiple addresses (explicit failure mode)

## Risks and Mitigations
- Risk: hidden clients depend on old payload envelope.
  - Mitigation: explicit breaking-change release note and coordinated client migration.
- Risk: behavior change in error surfaces.
  - Mitigation: snapshot tests for error symbols/messages.
- Risk: accidental weakening of validation.
  - Mitigation: keep peer/card cryptographic checks unchanged; add focused security regression tests.

## Acceptance Criteria
- Core functionality unchanged: `init`, `serve`, `hello`, `ping`, `capabilities`, `push`.
- Store interface is smaller and easier to reason about.
- Node and CLI code paths are shorter with fewer branches.
- No failing tests; race tests pass.
- Docs (`README.md`, `docs/cli.md`, `docs/architecture.md`) updated to reflect final behavior.
