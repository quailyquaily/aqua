# Aqua Protocol

This document describes the current wire format used by Aqua.

## 1. Transport Channels

- Hello negotiation stream protocol ID: `/aqua/hello/1.0.0`
- RPC stream protocol ID: `/aqua/rpc/1.0.0`

RPC method allowlist:

- `agent.ping`
- `agent.capabilities.get`
- `agent.card.get`
- `agent.data.push`

## 2. Hello Negotiation Message

The `hello` stream carries a JSON object:

```json
{
  "type": "hello",
  "protocol_min": 1,
  "protocol_max": 1,
  "capabilities": ["rpc.data.push.v1"]
}
```

Purpose: complete protocol capability negotiation before regular RPC calls.

## 3. RPC Envelope (JSON-RPC 2.0)

All RPC requests and responses use JSON-RPC 2.0 over `/aqua/rpc/1.0.0`.

Request example:

```json
{
  "jsonrpc": "2.0",
  "id": "req_019c...",
  "method": "agent.data.push",
  "params": {}
}
```

Success response example:

```json
{
  "jsonrpc": "2.0",
  "id": "req_019c...",
  "result": {}
}
```

Error response example:

```json
{
  "jsonrpc": "2.0",
  "id": "req_019c...",
  "error": {
    "code": -32602,
    "message": "ERR_INVALID_PARAMS",
    "data": {
      "details": "..."
    }
  }
}
```

## 4. `agent.data.push` Wire Message

### 4.1 Request Params

```json
{
  "topic": "chat.message",
  "content_type": "text/plain",
  "payload_base64": "SGk",
  "idempotency_key": "msg:07066767_df40_47b0_969a_f5e48f4c376a",
  "session_id": "019c81ef-47a9-7f06-9197-66560ce564c7",
  "reply_to": ""
}
```

Field notes:

- `topic`: required. Currently only `chat.message` is treated as a dialogue topic.
- `content_type`: required.
- `payload_base64`: required. Raw payload bytes encoded with base64url (raw, no padding).
- `idempotency_key`: required. Used for deduplication.
- `session_id`: optional; for `chat.message` it effectively must be UUIDv7 (auto-generated by CLI when omitted).
- `reply_to`: optional.

Note: `aqua send` no longer applies a second JSON envelope to payload content. It sends message bytes directly.

### 4.2 Success Result

```json
{
  "accepted": true,
  "deduped": false
}
```

## 5. `aqua send` to Wire Mapping

Command:

```bash
aqua send <peer_id> "Hi"
```

Key mapping:

- payload `"Hi"` -> `payload_base64: "SGk"`
- default `topic`: `chat.message`
- default `content_type`: `text/plain`
- `idempotency_key` is auto-generated when omitted (`msg:...`)
- `session_id` is auto-generated UUIDv7 when omitted

## 6. `serve --json` Output Is Not Raw Wire Data

`aqua serve --json` prints a local event view, with fields such as:

- `event`
- `from_peer_id`
- `topic`
- `content_type`
- `payload_base64`
- `payload_text`
- `received_at`

This is not the original JSON-RPC wire payload from the remote peer. It is a local structured event after decode and handling.
